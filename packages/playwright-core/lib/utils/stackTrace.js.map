{"version":3,"sources":["../../src/utils/stackTrace.ts"],"names":["stackUtils","StackUtils","rewriteErrorMessage","e","newMessage","lines","stack","split","filter","l","startsWith","message","errorTitle","name","length","join","CORE_DIR","path","resolve","__dirname","CLIENT_LIB","CLIENT_SRC","TEST_DIR_SRC","TEST_DIR_LIB","WS_LIB","relative","process","cwd","dirname","require","captureStackTrace","stackTraceLimit","Error","error","isTesting","parsedFrames","map","line","frame","parseLine","file","function","endsWith","fileName","includes","inClient","parsed","column","frameText","Boolean","apiName","allFrames","TRAP","expectIndex","findIndex","f","text","aliasIndex","indexOf","substring","slice","i","toLowerCase","p","frames","frameTexts","splitErrorMessage","separationIdx"],"mappings":"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","sourcesContent":["/**\n * Copyright (c) Microsoft Corporation.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n * http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport path from 'path';\nimport { StackFrame } from '../protocol/channels';\nimport StackUtils from 'stack-utils';\nimport { isUnderTest } from './utils';\n\nconst stackUtils = new StackUtils();\n\nexport function rewriteErrorMessage<E extends Error>(e: E, newMessage: string): E {\n  const lines: string[] = (e.stack?.split('\\n') || []).filter(l => l.startsWith('    at '));\n  e.message = newMessage;\n  const errorTitle = `${e.name}: ${e.message}`;\n  if (lines.length)\n    e.stack = `${errorTitle}\\n${lines.join('\\n')}`;\n  return e;\n}\n\nconst CORE_DIR = path.resolve(__dirname, '..', '..');\nconst CLIENT_LIB = path.join(CORE_DIR, 'lib', 'client');\nconst CLIENT_SRC = path.join(CORE_DIR, 'src', 'client');\nconst TEST_DIR_SRC = path.resolve(CORE_DIR, '..', 'playwright-test');\nconst TEST_DIR_LIB = path.resolve(CORE_DIR, '..', '@playwright', 'test');\nconst WS_LIB = path.relative(process.cwd(), path.dirname(require.resolve('ws')));\n\nexport type ParsedStackTrace = {\n  allFrames: StackFrame[];\n  frames: StackFrame[];\n  frameTexts: string[];\n  apiName: string | undefined;\n};\n\nexport function captureStackTrace(): ParsedStackTrace {\n  const stackTraceLimit = Error.stackTraceLimit;\n  Error.stackTraceLimit = 30;\n  const error = new Error();\n  const stack = error.stack!;\n  Error.stackTraceLimit = stackTraceLimit;\n\n  const isTesting = isUnderTest();\n  type ParsedFrame = {\n    frame: StackFrame;\n    frameText: string;\n    inClient: boolean;\n  };\n  let parsedFrames = stack.split('\\n').map(line => {\n    const frame = stackUtils.parseLine(line);\n    if (!frame || !frame.file)\n      return null;\n    // Node 16+ has node:internal.\n    if (frame.file.startsWith('internal') || frame.file.startsWith('node:'))\n      return null;\n    // EventEmitter.emit has 'events.js' file.\n    if (frame.file === 'events.js' && frame.function?.endsWith('.emit'))\n      return null;\n    // Node 12\n    if (frame.file === '_stream_readable.js' || frame.file === '_stream_writable.js')\n      return null;\n    if (frame.file.startsWith(WS_LIB))\n      return null;\n    const fileName = path.resolve(process.cwd(), frame.file);\n    if (isTesting && fileName.includes(path.join('playwright', 'tests', 'config', 'coverage.js')))\n      return null;\n    const inClient = fileName.startsWith(CLIENT_LIB) || fileName.startsWith(CLIENT_SRC);\n    const parsed: ParsedFrame = {\n      frame: {\n        file: fileName,\n        line: frame.line,\n        column: frame.column,\n        function: frame.function,\n      },\n      frameText: line,\n      inClient\n    };\n    return parsed;\n  }).filter(Boolean) as ParsedFrame[];\n\n  let apiName = '';\n  const allFrames = parsedFrames;\n\n  // expect matchers have the following stack structure:\n  // at Object.__PWTRAP__[expect.toHaveText] (...)\n  // at __EXTERNAL_MATCHER_TRAP__ (...)\n  // at Object.throwingMatcher [as toHaveText] (...)\n  const TRAP = '__PWTRAP__[';\n  const expectIndex = parsedFrames.findIndex(f => f.frameText.includes(TRAP));\n  if (expectIndex !== -1) {\n    const text = parsedFrames[expectIndex].frameText;\n    const aliasIndex = text.indexOf(TRAP);\n    apiName = text.substring(aliasIndex + TRAP.length, text.indexOf(']'));\n    parsedFrames = parsedFrames.slice(expectIndex + 3);\n  } else {\n    // Deepest transition between non-client code calling into client code\n    // is the api entry.\n    for (let i = 0; i < parsedFrames.length - 1; i++) {\n      if (parsedFrames[i].inClient && !parsedFrames[i + 1].inClient) {\n        const frame = parsedFrames[i].frame;\n        apiName = frame.function ? frame.function[0].toLowerCase() + frame.function.slice(1) : '';\n        parsedFrames = parsedFrames.slice(i + 1);\n        break;\n      }\n    }\n  }\n\n  // Hide all test runner and library frames in the user stack (event handlers produce them).\n  parsedFrames = parsedFrames.filter((f, i) => {\n    if (f.frame.file.startsWith(TEST_DIR_SRC) || f.frame.file.startsWith(TEST_DIR_LIB))\n      return false;\n    if (i && f.frame.file.startsWith(CORE_DIR))\n      return false;\n    return true;\n  });\n\n  return {\n    allFrames: allFrames.map(p => p.frame),\n    frames: parsedFrames.map(p => p.frame),\n    frameTexts: parsedFrames.map(p => p.frameText),\n    apiName\n  };\n}\n\nexport function splitErrorMessage(message: string): { name: string, message: string } {\n  const separationIdx = message.indexOf(':');\n  return {\n    name: separationIdx !== -1 ? message.slice(0, separationIdx) : '',\n    message: separationIdx !== -1 && separationIdx + 2 <= message.length ? message.substring(separationIdx + 2) : message,\n  };\n}\n"],"file":"stackTrace.js"}